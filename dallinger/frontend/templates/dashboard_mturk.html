{% extends "base/dashboard.html" %}

{% block stylesheets %}
<style type="text/css">
    .popover-body { font-family: monospace; };
</style>
{% endblock %}

{% block body %}
<h1>MTurk Dashboard
<small class="text-muted" style="float: right">Last updated {{ data["last_updated"] }}
    <button type="button" class="btn btn-secondary" onclick="location.reload()">
        Reload
    </button>
    <button type="button"
            class="btn btn-danger"
            data-toggle="popover" title="Dallinger CLI Command"
            data-content="{{ data['expire_command'] }}">Expire HIT</button>
    <button type="button"
            class="btn btn-primary"
            data-toggle="modal" data-target="#hit-extension-modal">Extend HIT</button>
</small>

</h1>

{% if data %}

    <h2>General</h2>
    <div class="row">
      <div class="col-sm">Account Balance: {{ data["account_balance"] }}</div>
      <div class="col-sm"><a href="{{ data['requester_url'] }}">Requester Account</a></div>
      <div class="col-sm"><a href="{{ data['qualification_types_url'] }}">Qualification Types</a></div>
    </div>


    <h2>Current HIT Information</h2>

    {% if data["hit_info"] %}
        <table class="table table-sm table-striped">
        {% for key, value in data["hit_info"].items() %}
            <tr><th>{{ key }}</th><td>{{ value }}</td></tr>

        {% endfor %}
        </table>

        <h3>Preview of AD page running <a href="{{ data['ad_url'] }}">on Heroku</a></h3>
        <iframe width="100%" height="600" src="{{  data['ad_url'] }}" /></iframe>
    {% else %}
        <div class="alert alert-warning">
            HIT data not available until first participant joins.
        </div>
    {% endif %}


{% endif %}

<!-- HIT Extension Modal -->
<div class="modal fade"
     id="hit-extension-modal"
     data-backdrop="static"
     data-keyboard="false"
     tabindex="-1"
     role="dialog"
     aria-labelledby="hit-extension-form-label"
     aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="hit-extension-form-label">Update MTurk HIT Expiration and Assignments</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="hit-extension-form">
          <div class="form-group">
            <label for="new-expiration">Extend until:</label>
            <input type="datetime-local"
                   id="new-expiration"
                   class="form-control"
                   name="new-expiration">

            <label for="additional-assignments">Additional assignments:</label>
            <input type="number"
                   id="additional-assignments"
                   class="form-control"
                   value="0"
                   name="additional-assignments">

          </div>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Extend HIT</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script type="text/javascript">

    function buildExtendCommand(event) {
        alert("Extend until: " + $("#new-expiration").val() + " and make " + $("#additional-assignments").val() + " more assignments.");
    }

    $(function () {
      $('[data-toggle="popover"]').popover();
      $("#hit-extension-form").submit(function (event) {
        buildExtendCommand(event);
        event.preventDefault();
      });
      $('[data-toggle="popover"]').click(async event => {
        if (!navigator.clipboard) {
          // Clipboard API not available
          return
        }
        const text = event.target.dataset.content
        try {
          await navigator.clipboard.writeText(text)
        } catch (err) {
          console.error('Failed to copy!', err)
        }
      })
    })
</script>
{% endblock %}