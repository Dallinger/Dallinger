{% extends "base/dashboard.html" %}

{% block body %}
    <h1>Logger</h1>
    <span id="info-text">
    Below are the logs for the experiment. You can filter the logs by log level. By clicking on the line number, you can
    get a link to that specific line.
    </span>
    <form id="search-form" class="mb-3">
        <div class="input-group">
            <input type="text" class="form-control" name="query"
                   placeholder="Search the logs for a particular substring (case sensitive)...">
            <button class="btn btn-primary" type="submit">Search</button>
        </div>
    </form>

    <div id="filters"></div>
    <div>
    </div>
    <div id="log-container">
        <table id="log" class="monospace">
            <tbody>
            </tbody>
        </table>
    </div>

    <style>
        #log-container {
            overflow: auto;
            height: 80vh;
            font-size: .875em;
            background: #f6f8fa;
            padding: 16px;
            color: #1f2328;
        }

        #log-container pre {
            font-size: 1em;
        }

        .monospace {
            font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
        }

        #log {
            caption-side: bottom;
        }

        #log a {
            color: inherit;
        }

        #log tr {
            vertical-align: top;
        }

        #log tr.highlight {
            background: lightyellow;
        }

        .level-checkbox {
            margin-right: 10px;
            font-weight: bold;
        }

    </style>

    <script>
        const logLevels = ["DEBUG", "INFO", "SUCCESS", "WARNING", "ERROR", "CRITICAL"];
        const colors = {
            "DEBUG": "#4d98cc",
            "SUCCESS": "#79b25f",
            "WARNING": "#ddaa2d",
            "ERROR": "#cf3f61",
            "CRITICAL": "#cf3f61",
            "DEFAULT": "#6c757d"
        };

        // Function to create checkboxes dynamically
        function createCheckbox(level) {
            const color = colors[level] || colors.DEFAULT;
            return `<label class="level-checkbox" style="color: ${color};">
                <input type="checkbox" value="${level}" checked> ${level}
            </label>`;
        }

        // Append checkboxes to the filter div
        document.addEventListener("DOMContentLoaded", () => {
            const filtersDiv = document.getElementById("filters");
            logLevels.forEach(level => {
                filtersDiv.innerHTML += createCheckbox(level);
            });

            document.querySelectorAll('.level-checkbox input').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    document.querySelectorAll(`.status-${this.value.toLowerCase()}`)
                        .forEach(row => row.style.display = this.checked ? "table-row" : "none");
                });
            });

            activateTooltips();
            setupSearchReset();
            fetchLogData();
        });

        // Function to activate Bootstrap tooltips
        function activateTooltips() {
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl, {
                boundary: 'viewport',
                sanitize: false,
                html: true
            }));
        }

        const highlightLine = new URLSearchParams(window.location.search).get('highlight');

        function moveToHighlight() {
            if (highlightLine) {
                const line = document.getElementById(`line-${highlightLine}`);
                if (line) {
                    line.scrollIntoView();
                }
            }
        }

        // Function to reset search query
        function setupSearchReset() {
            if (window.location.search.includes('query')) {
                document.querySelector('input[name="query"]').value = new URLSearchParams(window.location.search).get('query');
                const infoText = document.getElementById('info-text');
                const resetButton = document.createElement('button');
                resetButton.innerHTML = "Reset search";
                resetButton.className = "btn btn-secondary btn-small my-3";
                resetButton.onclick = () => window.location.href = window.location.pathname;
                infoText.innerHTML += " The logs have been filtered by the search query.<br>";
                infoText.appendChild(resetButton);
            }
        }

        function removeCredsFromUrl() {
            let url = new URL(document.URL);
            if (url.username !== "" && url.password !== "") {
                url = window.location.href;
                // Forward to url
                console.log("Redirecting to: " + url);
                window.location.replace(url);
            }
        }

        removeCredsFromUrl();

        const endpoint = "/dashboard/logs";
        // Fetch logs and append them dynamically
        function fetchLogData() {
            if (window.location.search.includes('start') || window.location.search.includes('end')) {
                let badResponse = false;
                const logContainer = document.querySelector("#log tbody");
                fetch(endpoint + window.location.search)
                    .then(response => {
                        if (!response.ok) {
                            badResponse = true;
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (badResponse) {
                            throw new Error(data.msg);
                        }
                        logContainer.innerHTML = "";
                        data.forEach(line => logContainer.appendChild(printLogLine(line)));
                        activateTooltips();
                        moveToHighlight();
                    })
                    .catch(error => {
                        console.error('There has been a problem with your fetch operation:', error);
                        $("#log tbody").append(`<tr><td colspan="3" style="color: ${colors.red};">Error: ${error.message}</td></tr>`);
                    });

            } else {
                var source = new EventSource(endpoint + window.location.search);
                source.onmessage = function (event) {
                    let data = JSON.parse(event.data);
                    if (data.stop) {
                        moveToHighlight();
                        source.close();
                    } else {
                        $("#log tbody").prepend(printLogLine(data));
                        activateTooltips()
                    }
                }
            }
        }

        // Function to generate log row HTML
        function printLogLine(data) {
            const color = colors[data.levelname] || "inherit";
            const source = data.name === "werkzeug" ? "werkzeug" : `${data.filename}:${data.name || ""}:${data.lineno}`;
            const tooltipText = `<span style='font-weight: bold'>Time</span> <span class='monospace'>${data.asctime}</span><br>
                         <span style='font-weight: bold'>Source</span> <span class='monospace'>${source}</span>`;

            const row = document.createElement("tr");
            row.classList.add(`status-${data.levelname.toLowerCase()}`);
            if (parseInt(new URLSearchParams(window.location.search).get('highlight')) === parseInt(data.log_line_number)) {
                row.classList.add("highlight");
            }

            let lineNumber = data.log_line_number;
            row.id = `line-${lineNumber}`;
            let url = `?highlight=${data.log_line_number}&start=${data.log_line_number - 10}&end=${data.log_line_number + 10}`
            row.innerHTML = `<td><a href="${url}">${data.log_line_number}</a></td>`
            row.innerHTML += `<td data-bs-toggle="tooltip" data-bs-html="true" data-bs-placement="left" title="${tooltipText}" style="color: ${color}; font-weight: bold">${data.levelname}</td>`
            let message = data.message.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
            message = `<span style="color: ${color}">${message}</span>`
            if (data.exc_info) {
                message += `<pre>${data.exc_info}</pre>`
            }
            row.innerHTML += `<td>${message}</td>`;

            return row;
        }
    </script>

{% endblock %}